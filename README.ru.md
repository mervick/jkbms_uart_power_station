# Контроллер зарядки JK BMS для электростанции

[Ру версия](README.ru.md) | [English](README.md)

Этот проект предназначен для мониторинга батареи через **JK BMS** (JiKong) и автоматического управления процессом зарядки с помощью реле.

Модуль работает на **Arduino Pro Micro** (ATmega32U4) и использует аппаратный UART интерфейс для связи с BMS.

Предотвращает микрозапуски, отключая зарядное устройство при достижении **100% SOC** и падении тока заряда ниже безопасного порога насыщения (например, **0.8A**).

## Возможности

- **Аппаратный UART**: Использует выделенный порт Serial1 на Pro Micro для стабильной связи с BMS.
- **Умочное отключение**: Отслеживает ток и SOC в реальном времени, активируя реле для полного отключения зарядки.

---

## Аппаратная настройка: Arduino Pro Micro

Arduino Pro Micro идеален для этого проекта благодаря компактным размерам и выделенному аппаратному Serial порту (`Serial1`).

### Схема подключения

| Компонент | Пин компонента | Пин Pro Micro | Описание |
| :--- | :--- | :--- | :--- |
| **BMS UART** | **GND** | **GND** | Общий GND |
| **BMS UART** | **TX** | **RX (Pin 0)** | Данные от BMS к Pro Micro |
| **BMS UART** | **RX** | **TX (Pin 1)** | Команды от Pro Micro к BMS |
| **Модуль реле** | **Signal / IN** | **Pin 3** | Сигнал управления реле |
| **Модуль реле** | **GND** | **GND** | Общий GND |
| **Питание** | **+5V** | **RAW** | Основное питание Arduino |
| **Питание** | **GND** | **GND** | Земля питания |

---

## Установка и настройка ПО

### 1. Настройка Arduino IDE

Для загрузки кода на Pro Micro:

1. Откройте **Tools** -> **Board**.
2. Выберите **Arduino Leonardo** или **Arduino Micro** (Pro Micro функционально идентичен Leonardo).
3. Выберите правильный **Port**:
* **macOS**: `/dev/cu.usbmodem...`
* **Ubuntu**: `/dev/ttyACM0` (Убедитесь в правах: `sudo usermod -a -G dialout $USER`).

### 2. Конфигурация

В файле `.ino` интерфейс `JKBMSInterface` инициализируется через `&Serial1`. Это разделяет отладочные логи (USB `Serial`) и связь с BMS (аппаратные пины 0 и 1 `Serial1`).

```cpp
Serial1.begin(115200);
// Эта строка в файле .ino использует аппаратные пины Pro Micro (0 и 1)
JKBMSInterface bms(&Serial1);
```

---

## Логика работы

1. **Сбор данных**: Каждые 10 секунд МК запрашивает данные у BMS через `Serial1`.
2. **Отслеживание пика**: Система мониторит максимальный ток заряда.
3. **Триггер отключения**: Если `SOC == 100%` И ток `<= 0.8A` (и ток снижается), активируется `RELAY_PIN` (Pin 3).
4. **Блокировка безопасности**: После срабатывания система переходит в режим `IDLE`, предотвращая циклическое включение/выключение зарядки.

---

## Справочник API (`JKBMSInterface`)

| Метод | Возвращает | Описание |
| --- | --- | --- |
| `getSOC()` | `uint8_t` | Уровень заряда в % (0-100) |
| `getVoltage()` | `float` | Общее напряжение батареи |
| `getCurrent()` | `float` | Ампер (Положительный = Разряд, Отрицательный = Заряд) |
| `getCellVoltage(i)` | `float` | Напряжение ячейки с индексом `i` |
| `isCharging()` | `bool` | `true` если ток поступает в батарею [1] |

